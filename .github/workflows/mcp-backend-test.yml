name: MCP â†” Backend í†µì‹  í…ŒìŠ¤íŠ¸

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'figure-mcp/**'
      - 'figure-backend/**'
      - '.github/workflows/mcp-backend-test.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'figure-mcp/**'
      - 'figure-backend/**'

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Unit Tests (ë¹ ë¥¸ í”¼ë“œë°±)
  unit-tests:
    name: ğŸ”§ Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'figure-mcp/package-lock.json'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: figure-mcp
      run: npm ci
      
    - name: TypeScript ë¹Œë“œ
      working-directory: figure-mcp
      run: npm run build
      
    - name: Unit Tests ì‹¤í–‰
      working-directory: figure-mcp
      run: |
        npx jest \
          --config tests/setup/jest.config.js \
          --testPathPattern=tests/unit \
          --coverage \
          --coverageDirectory=coverage/unit \
          --maxWorkers=2
      
    - name: ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: figure-mcp/coverage/unit/lcov.info
        flags: unit-tests
        name: unit-test-coverage
        
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          figure-mcp/coverage/
          figure-mcp/test-results/

  # Job 2: Integration & E2E Tests (Docker í™˜ê²½ í•„ìš”)
  integration-e2e-tests:
    name: ğŸ”— Integration & E2E Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'figure-mcp/package-lock.json'
        
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'figure-backend/requirements.txt'
        
    - name: MCP ì„œë²„ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
      working-directory: figure-mcp
      run: |
        npm ci
        npm run build
        
    - name: Python ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: figure-backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ChromaDB ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
      run: mkdir -p figure-backend/data/chroma
      
    - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "FIGURE_HOST=0.0.0.0" >> $GITHUB_ENV
        echo "FIGURE_PORT=8001" >> $GITHUB_ENV
        echo "FIGURE_DEBUG=false" >> $GITHUB_ENV
        echo "FIGURE_DATABASE_URL=sqlite:///./data/figure.db" >> $GITHUB_ENV
        echo "FIGURE_CHROMA_PERSIST_DIRECTORY=./data/chroma" >> $GITHUB_ENV
        echo "FIGURE_CHROMA_COLLECTION_NAME=test_documents" >> $GITHUB_ENV
        echo "BACKEND_API_URL=http://localhost:8001/api" >> $GITHUB_ENV
        echo "MCP_QUIET=true" >> $GITHUB_ENV
        
    - name: ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
      working-directory: figure-backend
      run: |
        python -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --log-level error &
        echo $! > backend.pid
        
        # ë°±ì—”ë“œ ì„œë²„ ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
        for i in {1..30}; do
          if curl -f -s http://localhost:8001/health > /dev/null; then
            echo "âœ… ë°±ì—”ë“œ ì„œë²„ ì¤€ë¹„ ì™„ë£Œ"
            break
          fi
          echo "â³ ë°±ì—”ë“œ ì„œë²„ ëŒ€ê¸° ì¤‘... ($i/30)"
          sleep 2
          if [ $i -eq 30 ]; then
            echo "âŒ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨"
            exit 1
          fi
        done
        
    - name: Integration Tests ì‹¤í–‰
      working-directory: figure-mcp
      run: |
        npx jest \
          --config tests/setup/jest.config.js \
          --testPathPattern=tests/integration \
          --runInBand \
          --forceExit \
          --detectOpenHandles \
          --testTimeout=30000 \
          --maxWorkers=1
          
    - name: E2E Tests ì‹¤í–‰
      working-directory: figure-mcp
      run: |
        npx jest \
          --config tests/setup/jest.config.js \
          --testPathPattern=tests/e2e \
          --runInBand \
          --forceExit \
          --detectOpenHandles \
          --testTimeout=60000 \
          --maxWorkers=1
      
    - name: ë°±ì—”ë“œ ì„œë²„ ì¢…ë£Œ
      if: always()
      working-directory: figure-backend
      run: |
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
          rm backend.pid
        fi
        
    - name: ë°±ì—”ë“œ ë¡œê·¸ ìˆ˜ì§‘
      if: failure()
      run: |
        echo "=== ë°±ì—”ë“œ ì„œë²„ ë¡œê·¸ ==="
        cat figure-backend/logs/*.log || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
        
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-e2e-test-results
        path: |
          figure-mcp/test-results/
          figure-backend/logs/

  # Job 3: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë° ë¦¬í¬íŠ¸
  test-summary:
    name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•©
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-e2e-tests]
    if: always()
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (Unit)
      uses: actions/download-artifact@v4
      with:
        name: unit-test-results
        path: ./test-results/unit/
      continue-on-error: true
        
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (Integration & E2E)
      uses: actions/download-artifact@v4
      with:
        name: integration-e2e-test-results
        path: ./test-results/integration-e2e/
      continue-on-error: true
        
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        echo "# ğŸ¯ MCP â†” Backend í†µì‹  í…ŒìŠ¤íŠ¸ ê²°ê³¼" > test-summary.md
        echo "" >> test-summary.md
        echo "**ì‹¤í–‰ ì‹œê°„**: $(date)" >> test-summary.md
        echo "**ì»¤ë°‹**: ${{ github.sha }}" >> test-summary.md
        echo "**ë¸Œëœì¹˜**: ${{ github.ref }}" >> test-summary.md
        echo "" >> test-summary.md
        
        # Job ê²°ê³¼ í™•ì¸
        echo "## ğŸ“‹ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ë³„ ê²°ê³¼" >> test-summary.md
        echo "" >> test-summary.md
        
        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "âœ… **Unit Tests**: í†µê³¼" >> test-summary.md
        else
          echo "âŒ **Unit Tests**: ì‹¤íŒ¨" >> test-summary.md
        fi
        
        if [ "${{ needs.integration-e2e-tests.result }}" == "success" ]; then
          echo "âœ… **Integration & E2E Tests**: í†µê³¼" >> test-summary.md
        elif [ "${{ needs.integration-e2e-tests.result }}" == "failure" ]; then
          echo "âŒ **Integration & E2E Tests**: ì‹¤íŒ¨" >> test-summary.md
        else
          echo "â­ï¸ **Integration & E2E Tests**: ê±´ë„ˆëœ€" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "## ğŸ“Š ìƒì„¸ ì •ë³´" >> test-summary.md
        echo "" >> test-summary.md
        echo "- **í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸**: GitHub Actions Artifacts ì°¸ì¡°" >> test-summary.md
        echo "- **ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸**: Codecov ì°¸ì¡°" >> test-summary.md
        echo "- **ë¡œê·¸ íŒŒì¼**: ì‹¤íŒ¨ ì‹œ ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸ ê°€ëŠ¥" >> test-summary.md
        
        cat test-summary.md
        
    - name: PR ì½”ë©˜íŠ¸ ì‘ì„± (PRì¸ ê²½ìš°)
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # Job 4: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ (ì„ íƒì , main/master ë¸Œëœì¹˜ì—ì„œë§Œ)
  performance-benchmark:
    name: âš¡ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
    runs-on: ubuntu-latest
    needs: integration-e2e-tests
    if: contains(github.ref, 'refs/heads/main') || contains(github.ref, 'refs/heads/master')
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
      run: |
        echo "ğŸš€ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ ì¤€ë¹„ ì¤‘..."
        echo "ì¶”í›„ êµ¬í˜„ë  ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸"
        
        # ì—¬ê¸°ì— ì‹¤ì œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë¡œì§ ì¶”ê°€
        # ì˜ˆ: API ì‘ë‹µ ì‹œê°„ ì¸¡ì •, ë™ì‹œ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ ë“±
        
        echo "âœ… ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ"
