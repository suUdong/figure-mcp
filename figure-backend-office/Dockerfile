# Development Dockerfile for Figure Backend Office
FROM node:18-alpine

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# íŒ¨í‚¤ì§€ ê´€ë¦¬ì ì„¤ì •
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3001
ENV HOSTNAME="0.0.0.0"

# package.json ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package.json ./
RUN npm install

# ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ë³µì‚¬ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
COPY scripts/ ./scripts/

# ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬ ë° ê¶Œí•œ ì„¤ì • (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# ì¡°ê±´ë¶€ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
RUN echo '#!/bin/sh' > /usr/local/bin/conditional-entrypoint.sh && \
    echo 'echo "ğŸ” ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ íŒŒì¼ í™•ì¸ ì¤‘..."' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo 'if [ -f "/usr/local/bin/docker-entrypoint.sh" ] && [ -x "/usr/local/bin/docker-entrypoint.sh" ]; then' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  echo "ğŸš€ docker-entrypoint.sh íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì‹¤í–‰í•©ë‹ˆë‹¤..."' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  # Windows ì¤„ë°”ê¿ˆ ë¬¸ì ì œê±° (CRLF â†’ LF)' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  sed -i "s/\r$//" /usr/local/bin/docker-entrypoint.sh' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  exec /usr/local/bin/docker-entrypoint.sh "$@"' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo 'else' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  echo "âš ï¸  docker-entrypoint.sh íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤."' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  echo "ğŸ“¦ ê¸°ë³¸ Next.js ê°œë°œ ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  trap '\''echo "ğŸ›‘ ì„œë²„ ì¢…ë£Œ ì¤‘..."; kill $SERVER_PID 2>/dev/null; exit 0'\'' TERM INT' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  npm run dev &' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  SERVER_PID=$!' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo '  wait $SERVER_PID' >> /usr/local/bin/conditional-entrypoint.sh && \
    echo 'fi' >> /usr/local/bin/conditional-entrypoint.sh && \
    chmod +x /usr/local/bin/conditional-entrypoint.sh

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 3001

# ì¡°ê±´ë¶€ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ì„¤ì •
ENTRYPOINT ["/usr/local/bin/conditional-entrypoint.sh"] 